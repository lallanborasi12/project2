node {
      def appDir = '/var/www/html/nextjs-aap'

      stage('Clen Workspace'){
            echo 'Cleaning jnkins Workspace'
            deleteDir()
      }
      stage('Clone Repo')
      echo 'Cloning the repo'
      git (
            branch: 'master'
            url 'https://github.com/lallanborasi12/Projet1.git'

      )

      stage ('Deploy to EC2'){
            echo 'Deploying te EC2'
            sh """
            sudo mkdir  -p ${appDir}
            sudo chown -R jenkins:jenkins ${appDir}

            rsync -av --delete 
            --exclude='.git'
            --exclude='node_modules' . 
            / ${appDir}
            cd ${appDir}
            sudo npm install
            sudo npm run build 
            sudo fuser -k 3000/tcp ||
            true 
            npm run start 
            
            """
      }
      
}
