node {
    def appDir = '/var/www/html3/reactjs-app'

    stage('Clean Workspace'){
        echo 'Cleaning Jenkins Workspace'
        deleteDir()
    }

    stage('Clone Repo'){
        echo 'Cloning the repo'
        git(
            branch: 'master',
            url: 'https://github.com/lallanborasi12/Projet1.git'
        )
    }

    stage('Deploy to EC2'){
        echo 'Deploying to EC2'
        sh """
            sudo mkdir -p ${appDir}
            sudo chown -R jenkins:jenkins ${appDir}

            rsync -av --delete --exclude='.git' --exclude='node_modules' ./ ${appDir}

            cd ${appDir}
            sudo npm install
            sudo npm run build

            # Install PM2 if not installed
            if ! command -v pm2 > /dev/null; then
                sudo npm install -g pm2
            fi

            # Stop old process if running
            pm2 stop nextjs-app || true
            pm2 delete nextjs-app || true

            # Start app with PM2
            pm2 start npm --name "nextjs-app" -- run start

            # Save process list & enable startup on reboot
            pm2 save
            pm2 startup systemd -u jenkins --hp /home/jenkins
        """
    }
}
